<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Am I Still Contained?</title>
	
	<meta name="author" content="raesene">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="https://raesene.github.io/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://raesene.github.io/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="https://raesene.github.io/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="https://raesene.github.io/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="https://raesene.github.io/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="https://github.com/raesene">
				<i class="fa fa-github"></i>
			</a>
			
			
			
			<a type="button" class="navbar-toggle nav-link" href="https://bsky.app/profile/mccune.org.uk">
				<i class="fa fa-cloud"></i>
			</a>	
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:raesene@gmail.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="https://raesene.github.io/">
				<img src="https://www.gravatar.com/avatar/8c189c784a607c4b5d52b0c7ee69b036?s=35" class="img-circle" />
				Raesene's Ramblings
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="https://raesene.github.io/">Home</a></li>
				<li><a href="https://raesene.github.io/categories/index.html">Categories</a></li>
				<li><a href="https://raesene.github.io/tags/index.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="https://raesene.github.io/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="https://raesene.github.io/categories/index.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="https://raesene.github.io/tags/index.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="https://raesene.github.io/">
		<img src="https://www.gravatar.com/avatar/8c189c784a607c4b5d52b0c7ee69b036?s=150" class="img-circle" />
	</a>
	<h3 class="title">
        <a href="https://raesene.github.io/">Raesene's Ramblings</a>
    </h3>
</header>


<div id="bio" class="text-center">
	Security Geek, Kubernetes, Docker, Ruby, Hillwalking
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/raesene">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://bsky.app/profile/mccune.org.uk">
				<i class="fa fa-cloud fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:raesene@gmail.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://linkedin.com/in/rorym">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="https://raesene.github.io/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>Am I Still Contained? </h1>
</div>
	
<article>

	<div class="col-sm-10">
	 <span class="post-date">
	   
	   June 
	   9th,
	   
	   2025
	 </span>
	  <div class="article_body">
	  <p>This exploration started, as many do, with “huh that’s odd”. Specifically I was looking at the output of <a href="https://github.com/genuinetools/amicontained">amicontained</a> around filtered syscalls.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Seccomp: filtering
Blocked Syscalls <span class="o">(</span>54<span class="o">)</span>:
        MSGRCV SYSLOG SETSID USELIB USTAT SYSFS VHANGUP PIVOT_ROOT _SYSCTL ACCT SETTIMEOFDAY MOUNT UMOUNT2 SWAPON SWAPOFF REBOOT SETHOSTNAME SETDOMAINNAME IOPL IOPERM CREATE_MODULE INIT_MODULE DELETE_MODULE GET_KERNEL_SYMS QUERY_MODULE QUOTACTL NFSSERVCTL GETPMSG PUTPMSG AFS_SYSCALL TUXCALL SECURITY LOOKUP_DCOOKIE CLOCK_SETTIME VSERVER MBIND SET_MEMPOLICY GET_MEMPOLICY KEXEC_LOAD ADD_KEY REQUEST_KEY KEYCTL MIGRATE_PAGES UNSHARE MOVE_PAGES PERF_EVENT_OPEN FANOTIFY_INIT OPEN_BY_HANDLE_AT SETNS KCMP FINIT_MODULE KEXEC_FILE_LOAD BPF USERFAULTFD
</code></pre></div></div>

<p>Looking at the SYSCALLS that were listed as blocked, I noticed that there wasn’t any mention of IO_URING but I know that Docker <a href="https://github.com/moby/moby/pull/46762">blocks io_uring syscalls in the default profile</a>, so what’s going on?</p>

<h2 id="looking-at-the-source-code">Looking at the source code</h2>

<p>I decided to take a look at the source code to see what was going on and why it might not be working. In the <a href="https://github.com/genuinetools/amicontained/blob/568b0d35e60cb2bfc228ecade8b0ba62c49a906a/main.go#L187">seccompIter function</a> I found what looks like a relevant point. A for loop that iterates over each syscall one at a time.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">id</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">id</span> <span class="o">&lt;=</span> <span class="n">unix</span><span class="o">.</span><span class="n">SYS_RSEQ</span><span class="p">;</span> <span class="n">id</span><span class="o">++</span> 
</code></pre></div></div>

<p>The end point for the loop was a syscall called <code class="language-plaintext highlighter-rouge">SYS_RSEQ</code> and thanks to a very helpful lookup table <a href="https://filippo.io/linux-syscall-table/">here</a> I could see that that’s syscall <code class="language-plaintext highlighter-rouge">334</code>, and the IO_URING syscalls are 425-427, so we can see why they’re not being flagged, the loop doesn’t go that high!</p>

<h2 id="fixing-the-problem">Fixing the problem</h2>

<p>Whilst I’m not a professional developer by any stretch of the imagination (&lt;GEEK REFERENCE&gt; I’d liken myself to a rogue with the use magic device skill trying to get a wand of fireballs working by hitting the end of it &lt;/GEEK REFERENCE&gt;), I decided to take a stab at fixing the code to get it to include the IO_URING syscalls (and any other ones with higher numbers).</p>

<p>We could just increase the maximum number on the for loop, but that does run into a problem, which is that there’s a weird gap in the syscall numbers between 334 and 424. It appears that this was done to <a href="https://stackoverflow.com/a/63713244/537897">sync up syscall numbers in different processor architectures</a>, so we can just add a section to the code to skip those blank numbers.</p>

<p>The next tricky part is, it turns out making syscalls directly can sometimes cause the process to exit or hang. The original code has a number of <a href="https://github.com/genuinetools/amicontained/blob/568b0d35e60cb2bfc228ecade8b0ba62c49a906a/main.go#L190">blocks designed to skip tricky syscalls</a></p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code>		<span class="c">// these cause a hang, so just skip</span>
		<span class="c">// rt_sigreturn, select, pause, pselect6, ppoll</span>
		<span class="k">if</span> <span class="n">id</span> <span class="o">==</span> <span class="n">unix</span><span class="o">.</span><span class="n">SYS_RT_SIGRETURN</span> <span class="o">||</span> <span class="n">id</span> <span class="o">==</span> <span class="n">unix</span><span class="o">.</span><span class="n">SYS_SELECT</span> <span class="o">||</span> <span class="n">id</span> <span class="o">==</span> <span class="n">unix</span><span class="o">.</span><span class="n">SYS_PAUSE</span> <span class="o">||</span> <span class="n">id</span> <span class="o">==</span> <span class="n">unix</span><span class="o">.</span><span class="n">SYS_PSELECT6</span> <span class="o">||</span> <span class="n">id</span> <span class="o">==</span> <span class="n">unix</span><span class="o">.</span><span class="n">SYS_PPOLL</span> <span class="p">{</span>
			<span class="k">continue</span>
		<span class="p">}</span>
</code></pre></div></div>

<p>Here the approach ended up being a bit trial and error on what syscalls caused problems. Also an interesting aside is that this shows a limitation of this approach to enumerating syscalls, it’s not possible to get a definitive list as you can’t probe for every possible syscall!</p>

<p>With that largely working, it was just a question of extending the really long <a href="https://github.com/genuinetools/amicontained/blob/568b0d35e60cb2bfc228ecade8b0ba62c49a906a/main.go#L243">syscallName</a> function that has a case statement giving names for every syscall. This was also the only part of this that LLMs could help with (they got the main problem wildly wrong), and even here they only got most of it right.</p>

<p>After all that it looks like this largely works. As the original repository seems unmaintained, I’ve put a fork <a href="https://github.com/raesene/amicontained">here</a> with the updated code.</p>

<h2 id="conclusion">Conclusion</h2>

<p>This one was interesting for a number of reasons. First up was a good reminder that you can’t rely on tools always working the way they used to, as the underlying systems change. The second one was that I learned quite a bit about the limitations of closed box testing of syscalls, and also as a side lesson, the current limitations of LLMs when dealing with relatively obscure lower level tech.</p>

	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="https://raesene.github.io/categories/index.html#seccomp-ref">
					seccomp <span>(1)</span>
					
				</a></li>
			
		  
		</ul>
		  

		  

		<hr>

		<div>
	<!--
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="https://twitter.com/share?text=Am I Still Contained?"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>
	  -->		

      <section class="col-sm-6 author">
        <img src="https://www.gravatar.com/avatar/8c189c784a607c4b5d52b0c7ee69b036" class="img-rounded author-image" />
        <h4 class="section-title author-name">raesene</h4>
        <p class="author-bio">Security Geek, Kubernetes, Docker, Ruby, Hillwalking</p>
      </section>
    </div>

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="https://raesene.github.io/blog/2025/05/30/kubernetes-debug-profiles/" title="Kubernetes Debug Profiles">&larr; Previous</a></li>
		  
		  
			<li class="next disabled"><a>Next &rarr;</a>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>





		<footer>
			<hr/>
			<p>
				&copy; 2025 raesene with Jekyll. Theme: <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="https://raesene.github.io/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="https://raesene.github.io/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="https://raesene.github.io/assets/js/app.js"></script>
</body>
</html>


