<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Cap or no cap</title>
	
	<meta name="author" content="raesene">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="https://raesene.github.io/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://raesene.github.io/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="https://raesene.github.io/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="https://raesene.github.io/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="https://raesene.github.io/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="https://github.com/raesene">
				<i class="fa fa-github"></i>
			</a>
			
			
			
			<a type="button" class="navbar-toggle nav-link" href="https://bsky.app/profile/mccune.org.uk">
				<i class="fa fa-cloud"></i>
			</a>	
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:raesene@gmail.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="https://raesene.github.io/">
				<img src="https://www.gravatar.com/avatar/8c189c784a607c4b5d52b0c7ee69b036?s=35" class="img-circle" />
				Raesene's Ramblings
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="https://raesene.github.io/">Home</a></li>
				<li><a href="https://raesene.github.io/categories/index.html">Categories</a></li>
				<li><a href="https://raesene.github.io/tags/index.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="https://raesene.github.io/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="https://raesene.github.io/categories/index.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="https://raesene.github.io/tags/index.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="https://raesene.github.io/">
		<img src="https://www.gravatar.com/avatar/8c189c784a607c4b5d52b0c7ee69b036?s=150" class="img-circle" />
	</a>
	<h3 class="title">
        <a href="https://raesene.github.io/">Raesene's Ramblings</a>
    </h3>
</header>


<div id="bio" class="text-center">
	Security Geek, Kubernetes, Docker, Ruby, Hillwalking
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/raesene">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://bsky.app/profile/mccune.org.uk">
				<i class="fa fa-cloud fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:raesene@gmail.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://linkedin.com/in/rorym">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="https://raesene.github.io/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>Cap or no cap </h1>
</div>
	
<article>

	<div class="col-sm-10">
	 <span class="post-date">
	   
	   April 
	   23rd,
	     
	   2025
	 </span>
	  <div class="article_body">
	  <p>I was looking at a <a href="https://github.com/kubernetes/kubernetes/issues/131336">Kubernetes issue</a> the other day and it led me down a kind of interesting rabbit hole, so I thought it’d be worth sharing as I learned a couple of things.</p>

<h2 id="background">Background</h2>

<p>The issue is to do with the interaction of <code class="language-plaintext highlighter-rouge">allowPrivilegeEscalation</code> and added capabilities in a Kubernetes workload specification. In the issue the reporter noted that if you add <code class="language-plaintext highlighter-rouge">CAP_SYS_ADMIN</code> to a manifest while setting <code class="language-plaintext highlighter-rouge">allowPrivilegeEscalation: false</code> it blocks the deploy but other capabilities when added do not block.</p>

<p><code class="language-plaintext highlighter-rouge">allowPrivilegeEscalation</code> is kind of an interesting flag as it doesn’t really do what the name says. In reality, what it does is set a specific Linux Kernel setting designed to stop a process from getting more privileges than when it started, however the name implies it’s intended to do a more wide ranging set of blocks. My colleague Christophe has a <a href="https://blog.christophetd.fr/stop-worrying-about-allowprivilegeescalation/">detailed post looking at this misunderstanding</a>.</p>

<p>However what was specifically interesting to me was, when I tried out a quick manifest to re-create the problem, I wasn’t able to and the pod I created was admitted ok.</p>

<p>After a bit of looking I realised that when adding the capability, I’d used the name <code class="language-plaintext highlighter-rouge">SYS_ADMIN</code> instead of <code class="language-plaintext highlighter-rouge">CAP_SYS_ADMIN</code>, and it had worked fine, weird!</p>

<h2 id="exploring-whats-going-on">Exploring what’s going on</h2>

<p>I decided to put together a couple of quick test cases to understand what’s happening (manifests are <a href="https://github.com/raesene/k8sapecsa">here</a>).</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">capsysadminpod.yaml</code> - This pod adds <code class="language-plaintext highlighter-rouge">CAP_SYS_ADMIN</code> to the capabilities list</li>
  <li><code class="language-plaintext highlighter-rouge">sysadminpod.yaml</code> - This pod adds <code class="language-plaintext highlighter-rouge">SYS_ADMIN</code> to the capabilities list</li>
  <li><code class="language-plaintext highlighter-rouge">dontallowprivesccapsysadminpod.yaml</code> - This has <code class="language-plaintext highlighter-rouge">allowPrivilegeEscalation: false</code> set and adds <code class="language-plaintext highlighter-rouge">CAP_SYS_ADMIN</code> to the capabilities list</li>
  <li><code class="language-plaintext highlighter-rouge">dontallowprivescsysadminpod.yaml</code> - This has <code class="language-plaintext highlighter-rouge">allowPrivilegeEscalation: false</code> set and adds <code class="language-plaintext highlighter-rouge">SYS_ADMIN</code> to the capabilities list</li>
  <li><code class="language-plaintext highlighter-rouge">invalidcap.yaml</code> - This pod has an invalid capability (lorem) set.</li>
</ul>

<p>Trying these manifests out in a <a href="https://kind.sigs.k8s.io/">kind</a> cluster (using containerd as CRI) showed a couple of things</p>

<ul>
  <li>Adding <code class="language-plaintext highlighter-rouge">CAP_SYS_ADMIN</code> worked but there was no capability added.</li>
  <li>Adding <code class="language-plaintext highlighter-rouge">SYS_ADMIN</code> worked and the capability was added.</li>
  <li>setting <code class="language-plaintext highlighter-rouge">allowPrivilegeEscalation: false</code> and adding <code class="language-plaintext highlighter-rouge">CAP_SYS_ADMIN</code> was blocked</li>
  <li>setting <code class="language-plaintext highlighter-rouge">allowPrivilegeEscalation: false</code> and adding <code class="language-plaintext highlighter-rouge">SYS_ADMIN</code> was allowed and the capability was added.</li>
  <li>setting an invalid capability worked ok but no capability was added.</li>
</ul>

<p>So a couple of lessons from that. Kubernetes does not check what capabilities you add, and no error is generated if you add an invalid one, it just doesn’t do anything. Also there’s a redundant block in Kubernetes at the moment where something that doesn’t do anything is blocked, but something which does do something is allowed ok…</p>

<p>Doing some more searching on Github turned up some more history on this. Back in 2021, there was a <a href="https://github.com/kubernetes/kubernetes/pull/105237">PR to try and fix this</a> which didn’t get merged, and there’s another <a href="https://github.com/kubernetes/kubernetes/issues/119568">issue from 2023</a> on it as well.</p>

<p>From that one thing that caught my eye was that apparently CRI-O handles this differently than containerd, which I thought was interesting</p>

<h2 id="comparing-cri---with-iximiuz-labs">Comparing CRI - with iximiuz labs</h2>

<p>I wanted to test out this difference in behaviour, but unfortunately I don’t have a CRI-O backed cluster available on my test lab. Fortunately, iximiuz labs has an awesome <a href="https://labs.iximiuz.com/playgrounds/k8s-omni">Kubernetes playground</a> where you can specify various combinations of CRI and CNI to test out different scenarios, which is nice!</p>

<p>Testing out a cluster there with CRI-O confirmed that things are handled rather differently.</p>

<ul>
  <li>Adding <code class="language-plaintext highlighter-rouge">CAP_SYS_ADMIN</code> worked and the capability was added.</li>
  <li>Adding <code class="language-plaintext highlighter-rouge">SYS_ADMIN</code> worked and the capability was added.</li>
  <li>setting <code class="language-plaintext highlighter-rouge">allowPrivilegeEscalation: false</code> and adding <code class="language-plaintext highlighter-rouge">CAP_SYS_ADMIN</code> was blocked</li>
  <li>setting <code class="language-plaintext highlighter-rouge">allowPrivilegeEscalation: false</code> and adding <code class="language-plaintext highlighter-rouge">SYS_ADMIN</code> was allowed and the capability was added.</li>
  <li>setting an invalid capability resulted in an error on container creation.</li>
</ul>

<p>So we can see that CRI-O handles things a bit differently, allowing both <code class="language-plaintext highlighter-rouge">SYS_ADMIN</code> and <code class="language-plaintext highlighter-rouge">CAP_SYS_ADMIN</code> to work and erroring out on invalid capabilities!</p>

<h2 id="conclusion">Conclusion</h2>

<p>Sometimes we can assume that Kubernetes clusters will work the same way, so we can freely move workloads from one to another, regardless of distribution. This case provides an illustration of one way that that assumption might not hold up, and we can see some surprising results!</p>

	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="https://raesene.github.io/categories/index.html#Kubernetes-ref">
					Kubernetes <span>(64)</span>
					
				</a></li>
			
		  
		</ul>
		  

		  

		<hr>

		<div>
	<!--
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="https://twitter.com/share?text=Cap or no cap"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>
	  -->		

      <section class="col-sm-6 author">
        <img src="https://www.gravatar.com/avatar/8c189c784a607c4b5d52b0c7ee69b036" class="img-rounded author-image" />
        <h4 class="section-title author-name">raesene</h4>
        <p class="author-bio">Security Geek, Kubernetes, Docker, Ruby, Hillwalking</p>
      </section>
    </div>

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="https://raesene.github.io/blog/2025/03/14/cve-2025-1767-another-gitrepo-issue/" title="CVE-2025-1767 - Another gitrepo issue">&larr; Previous</a></li>
		  
		  
			<li class="next disabled"><a>Next &rarr;</a>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>





		<footer>
			<hr/>
			<p>
				&copy; 2025 raesene with Jekyll. Theme: <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="https://raesene.github.io/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="https://raesene.github.io/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="https://raesene.github.io/assets/js/app.js"></script>
</body>
</html>


