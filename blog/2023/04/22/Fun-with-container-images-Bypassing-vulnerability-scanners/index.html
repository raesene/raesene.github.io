<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Fun with container images - Bypassing vulnerability scanners</title>
	
	<meta name="author" content="raesene">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="https://raesene.github.io/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://raesene.github.io/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="https://raesene.github.io/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="https://raesene.github.io/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="https://raesene.github.io/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="https://github.com/raesene">
				<i class="fa fa-github"></i>
			</a>
			
			
			
			<a type="button" class="navbar-toggle nav-link" href="https://bsky.app/profile/mccune.org.uk">
				<i class="fa fa-cloud"></i>
			</a>	
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:raesene@gmail.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="https://raesene.github.io/">
				<img src="https://www.gravatar.com/avatar/8c189c784a607c4b5d52b0c7ee69b036?s=35" class="img-circle" />
				Raesene's Ramblings
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="https://raesene.github.io/">Home</a></li>
				<li><a href="https://raesene.github.io/categories/index.html">Categories</a></li>
				<li><a href="https://raesene.github.io/tags/index.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="https://raesene.github.io/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="https://raesene.github.io/categories/index.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="https://raesene.github.io/tags/index.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="https://raesene.github.io/">
		<img src="https://www.gravatar.com/avatar/8c189c784a607c4b5d52b0c7ee69b036?s=150" class="img-circle" />
	</a>
	<h3 class="title">
        <a href="https://raesene.github.io/">Raesene's Ramblings</a>
    </h3>
</header>


<div id="bio" class="text-center">
	Security Geek, Kubernetes, Docker, Ruby, Hillwalking
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/raesene">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://bsky.app/profile/mccune.org.uk">
				<i class="fa fa-cloud fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:raesene@gmail.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://linkedin.com/in/rorym">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="https://raesene.github.io/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>Fun with container images - Bypassing vulnerability scanners </h1>
</div>
	
<article>

	<div class="col-sm-10">
	 <span class="post-date">
	   
	   April 
	   22nd,
	     
	   2023
	 </span>
	  <div class="article_body">
	  <p>At Last week’s <a href="https://events.linuxfoundation.org/kubecon-cloudnativecon-europe/">Kubecon EU</a> I was fortunate enough to be on stage with <a href="https://twitter.com/IanColdwater">Ian Coldwater</a>, <a href="https://twitter.com/bradgeesaman">Brad Geesaman</a>, and <a href="https://twitter.com/mauilion">Duffie Cooley</a> presenting a talk called “<a href="https://sched.co/1Hybu">Malicious Compliance: Reflections on Trusting Container Scanners</a>”.</p>

<p>In this talk, one of the things we looked at was how it would be possible for a malicious container image to bypass container vulnerability scanners. We built up a set of techniques to demonstrate how this worked, with the details hosted on <a href="https://github.com/bgeesaman/malicious-compliance">GitHub</a>.</p>

<p>As with any talk we came up with quite a few ideas that we couldn’t fit in, for time, so I wanted to quickly talk about one I came up with as it’s a quick (and somewhat silly) way to bypass container vulnerability scanners.</p>

<h2 id="what-do-container-vulnerability-scanners-look-for">What do container vulnerability scanners look for?</h2>

<p>As we talked about during the presentation, there are a number of files and directories that contain information used by vulnerability scanners and SBOM tools to identify what software is installed in a container image, and what vulnerabilities are present in that software.</p>

<p>So obviously anything which stops the scanner look at those locations could interfere with their operation.  With that idea in mind, I was thinking of some ways to do this, and I came up with a simple one.</p>

<h2 id="runtime-image-extraction">Runtime image extraction</h2>

<p>If we have a container image which only creates the container filesystem at runtime then scanners (which operate statically on images, rather than executing them) won’t be able to see that filesystem, and will likely just return an empty set of results.</p>

<p>The way I came up with to do this was a simple golang program which takes a tarball and a command as arguments, then extracts the tarball and executes the command.</p>

<p>Before I talk about the code, I’ll make it clear this is purely a PoC it’s not something anyone should use in production!</p>

<p>The basic code looks like this :-</p>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"fmt"</span>
	<span class="s">"os"</span>
	<span class="s">"os/exec"</span>

	<span class="n">archiver</span> <span class="s">"github.com/mholt/archiver/v3"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="c">// Check if the correct number of arguments are provided</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="m">3</span> <span class="p">{</span>
		<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Usage: go run main.go &lt;tar_file&gt; &lt;file to execute&gt;"</span><span class="p">)</span>
		<span class="n">os</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="n">tarFile</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">1</span><span class="p">]</span>
	<span class="c">//password := os.Args[2]</span>
	<span class="n">destination</span> <span class="o">:=</span> <span class="s">"."</span>
	<span class="n">z</span> <span class="o">:=</span> <span class="n">archiver</span><span class="o">.</span><span class="n">Tar</span><span class="p">{</span>
		<span class="n">MkdirAll</span><span class="o">:</span>               <span class="no">true</span><span class="p">,</span>
		<span class="n">ContinueOnError</span><span class="o">:</span>        <span class="no">true</span><span class="p">,</span>
		<span class="n">OverwriteExisting</span><span class="o">:</span>      <span class="no">true</span><span class="p">,</span>
		<span class="n">ImplicitTopLevelFolder</span><span class="o">:</span> <span class="no">false</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="c">// Use archiver library to open and extract the ZIP file</span>
	<span class="n">err</span> <span class="o">:=</span> <span class="n">z</span><span class="o">.</span><span class="n">Unarchive</span><span class="p">(</span><span class="n">tarFile</span><span class="p">,</span> <span class="n">destination</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Failed to unzip:"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
		<span class="n">os</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Unzip completed successfully!"</span><span class="p">)</span>
	<span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">exec</span><span class="o">.</span><span class="n">Command</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">2</span><span class="p">])</span><span class="o">.</span><span class="n">Output</span><span class="p">()</span>
	<span class="c">//err = cmd.Run()</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Failed to execute:"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
		<span class="n">os</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"output %s"</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The code is pretty simple essentially we just take the tarball and extract it to the current directory, then execute the command provided as the second argument, which by that point can run binaries from the extracted tarball.</p>

<h2 id="building-the-binary">Building the binary</h2>

<p>An important note is that at the point the extractor runs there is nothing else in the container image, so it’ll need to be compiled statically. something like this.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">CGO_ENABLED</span><span class="o">=</span>0 go build <span class="nt">-ldflags</span><span class="o">=</span><span class="s2">"-s -w"</span> main.go
</code></pre></div></div>

<p>Once you’ve done that you can use a trick from the talk to ensure the binary itself doesn’t have any visible vulnerabilities. Just pack it with <code class="language-plaintext highlighter-rouge">upx</code> and that will fix that problem.</p>

<h2 id="getting-the-tarball-to-run">Getting the tarball to run</h2>

<p>With the binary built you can just create a tarball by using <code class="language-plaintext highlighter-rouge">docker export</code> with any running (or stopped) container. Any Docker image should work fine for this.</p>

<h2 id="building-the-docker-image">Building the Docker image</h2>

<p>Now you can create a Dockerfile like this :-</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> scratch</span>

<span class="k">COPY</span><span class="s"> image.tar /</span>
<span class="k">COPY</span><span class="s"> main /</span>

<span class="k">ENTRYPOINT</span><span class="s"> ["/main","image.tar"]</span>
</code></pre></div></div>

<p>An important point here is using <code class="language-plaintext highlighter-rouge">ENTRYPOINT</code> rather than <code class="language-plaintext highlighter-rouge">CMD</code> as we want to be able to pass an argument to <code class="language-plaintext highlighter-rouge">docker run</code> and have it be passed to <code class="language-plaintext highlighter-rouge">main</code> as the second argument.</p>

<p>With that docker file something like <code class="language-plaintext highlighter-rouge">docker build -t obfuscator .</code> should work fine.</p>

<h2 id="running-the-image">Running the image</h2>

<p>Now you can run the image like this would run the command <code class="language-plaintext highlighter-rouge">ls</code> in the container :-</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">--rm</span> obfuscator <span class="nb">ls</span>
</code></pre></div></div>

<h2 id="does-it-fool-scanners">Does it fool scanners?</h2>

<p>Of course none of this is terribly useful if it doesn’t actually fool scanners. Happily a check with Trivy, Grype, Docker Scan and Docker Scout came up clean, when using our super vulnerable <a href="https://github.com/bgeesaman/malicious-compliance/blob/main/docker/Dockerfile-0-base">base image</a> from the talk :)</p>

<h2 id="conclusion">Conclusion</h2>

<p>This is a pretty silly way to bypass scanners, but it hopefully makes a useful point, which was one of our takeaways from the talk. If you can’t trust the people that built a container image (or any other artifact) then you can’t rely on tools like container vulnerability scanners to tell you any useful information about the contents of that image. You need to consider what’s in the image yourself, and make your own decisions about whether it’s safe to use! In case anyone wants to have a look at this, the code is <a href="https://github.com/raesene/container_image_obfuscator">on GitHub</a></p>


	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="https://raesene.github.io/categories/index.html#Kubernetes-ref">
					Kubernetes <span>(62)</span>
					
				</a></li>
			
		  
		</ul>
		  

		  

		<hr>

		<div>
	<!--
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="https://twitter.com/share?text=Fun with container images - Bypassing vulnerability scanners"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>
	  -->		

      <section class="col-sm-6 author">
        <img src="https://www.gravatar.com/avatar/8c189c784a607c4b5d52b0c7ee69b036" class="img-rounded author-image" />
        <h4 class="section-title author-name">raesene</h4>
        <p class="author-bio">Security Geek, Kubernetes, Docker, Ruby, Hillwalking</p>
      </section>
    </div>

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="https://raesene.github.io/blog/2023/04/08/lets-talk-about-kubelet-authorization/" title="Let's talk about Kubelet authorization">&larr; Previous</a></li>
		  
		  
		  <li class="next"><a href="https://raesene.github.io/blog/2023/07/16/code-server-on-EC2/" title="Getting a VS Code Server running on EC2">Next &rarr;</a></li>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>





		<footer>
			<hr/>
			<p>
				&copy; 2025 raesene with Jekyll. Theme: <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="https://raesene.github.io/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="https://raesene.github.io/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="https://raesene.github.io/assets/js/app.js"></script>
</body>
</html>


